<!DOCTYPE html lang="en">
<head>
    <title>CSSCrusaders Project</title>
    <link rel="stylesheet" type="text/css" href="/public/styles.css" />
    <link rel="shortcut icon" type="image/x-icon" href="/public/favicon.ico" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body onload="fetchAndRenderMessages();">
<div style="display:flex" class="title">
    <div style="flex: 70%;">
        <h2>CSE312 CSSCrusaders Project</h2>
    </div>
    <div style="display:flex; flex-direction: column; flex: 30%">
        <div style="display: flex;">
            <div style="align-self: center;">
                <p id="username-form">Your username: {{user}}</p>
            </div>
            <div style="display: flex;">
                <form style="align-self: center; margin-left: 5px; margin-bottom: 0px;"
                      action="/logout"
                      method="post"
                      enctype="application/x-www-form-urlencoded">
                    <input type="submit" value="Log Out" />
                </form>
            </div>
        </div>
        <div>
            <form style="display: flex; flex-direction:row" action="/chat-messages" id="chat-form" method="post">
                <input placeholder="Write your message here..." id="chat-text-box" type="text" name='message'>
                <input type="submit" value="Send">
            </form>
        </div>
    </div>
</div>

<div class="header">
    <div class="main-div">
        <div class="image_div">
            <img src="/public/image/readme.jpg" alt="SQUIDWARD" class="squidward" />
        </div>
        <p id="post-title"></p>
        <div class="posts border-gradient" id="posts-container">
        </div>
    </div>
</div>

<script src="/public/app.js"></script>
<script>
    function fetchInitialLikeCountsAndMessages() {
        fetch("/get-messages")
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to fetch messages");
            }
            return response.json();
        })
        .then(messages => {
            renderMessages(messages);
            fetchInitialLikeCounts(messages);
        })
        .catch(error => {
            console.error("Error fetching messages:", error);
        });
    }
    // Function to render messages in the HTML container
    function renderMessages(messages) {
        const postsContainer = document.getElementById("posts-container");
        postsContainer.innerHTML = "";
        messages.forEach(message => {
            const postElement = document.createElement("div");
            postElement.classList.add("list-posts");
            postElement.dataset.postId = message.post_id;
            postElement.dataset.username = message.username;
            postElement.innerHTML = `
                <img src="${message.image}" alt="Profile Picture" width="50" height="50">
                ${message.username}: ${message.content}
                <div class="post-likes">
                    <span class="material-icons">thumb_up</span>
                    <span class="like-count">${message.likeCount}</span>
                </div>
            `;
            postsContainer.appendChild(postElement);
        });
    }
    function fetchInitialLikeCounts(messages) {
    messages.forEach(message => {
        const postId = message.post_id;
        const likeContainer = document.querySelector(`.post-likes[data-post-id="${postId}"]`);
        fetch(`/like`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                const counter = likeContainer.querySelector(".like-count");
                counter.innerText = data.likeCount;
            })
            .catch(error => {
                console.error("Error:", error);
            });
    });
}
</script>
</body>
</html>
